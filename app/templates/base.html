<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}News Management System{% endblock %}</title>
    <script src="https://unpkg.com/htmx.org@1.9.6"></script>
    <script src="https://unpkg.com/htmx.org/dist/ext/response-targets.js"></script>
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
    <header class="header">
        <nav class="navbar">
            <div class="nav-brand">
                <h1>üì∞ News Management System</h1>
            </div>
            <div class="nav-links">
                <a href="/" class="nav-link {% if request.url.path == '/' %}active{% endif %}">Home</a>
                <a href="/users" class="nav-link {% if request.url.path == '/users' %}active{% endif %}">Users</a>
                <a href="/news" class="nav-link {% if request.url.path == '/news' %}active{% endif %}">News</a>
                <a href="/comments" class="nav-link {% if request.url.path == '/comments' %}active{% endif %}">Comments</a>
                <div id="auth-section">
                    <!-- Auth buttons will be loaded here by JavaScript -->
                    <div class="loading">Loading...</div>
                </div>
                <a href="/docs" class="nav-link" target="_blank">API Docs</a>
            </div>
        </nav>
    </header>

    <main class="main-content">
        <div class="container">
            {% block content %}{% endblock %}
        </div>
    </main>

    <footer class="footer">
        <div class="container">
            <p>&copy; 2024 News Management System. Built with FastAPI & HTMX.</p>
        </div>
    </footer>

    <!-- Toast Container -->
    <div id="toast-container" class="toast-container"></div>

    <script src="/static/js/app.js"></script>
    
    <script>
    // Auth management functions
    async function updateAuthUI() {
        const authSection = document.getElementById('auth-section');
        if (!authSection) return;
        
        const token = localStorage.getItem('access_token');
        
        if (token) {
            try {
                const response = await fetch('/auth/check', {
                    headers: {
                        'Authorization': 'Bearer ' + token
                    }
                });
                
                if (response.ok) {
                    const user = await response.json();
                    authSection.innerHTML = `
                        <div class="user-nav">
                            <div class="user-info">
                                <span class="user-name">Hello, ${user.name}</span>
                                <div class="user-badges">
                                    ${user.is_verified ? '<span class="badge badge-success">Verified Author</span>' : ''}
                                    ${user.is_admin ? '<span class="badge badge-warning">Admin</span>' : ''}
                                </div>
                            </div>
                            <div class="user-actions">
                                ${user.is_verified ? '<a href="/news/create" class="btn btn-outline btn-sm">‚úèÔ∏è Create News</a>' : ''}
                                <button onclick="logout()" class="btn btn-outline btn-sm">üö™ Logout</button>
                            </div>
                        </div>
                    `;
                } else {
                    showLoginButtons();
                }
            } catch (error) {
                console.error('Auth check failed:', error);
                showLoginButtons();
            }
        } else {
            showLoginButtons();
        }
    }

    function showLoginButtons() {
        const authSection = document.getElementById('auth-section');
        authSection.innerHTML = `
            <div class="auth-buttons">
                <a href="/auth/login" class="nav-link">üîê Login</a>
                <a href="/auth/register" class="nav-link">üë§ Register</a>
                <a href="/auth/oauth/github/demo" class="btn btn-github btn-sm">
                     <span>üêô GitHub Demo</span>
                </a>
            </div>
        `;
    }

    function logout() {
        const refreshToken = localStorage.getItem('refresh_token');
        
        if (refreshToken) {
            // Call logout endpoint to invalidate refresh token
            fetch('/auth/logout', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ refresh_token: refreshToken })
            }).catch(error => {
                console.error('Logout API call failed:', error);
            });
        }
        
        // Clear local storage
        localStorage.removeItem('access_token');
        localStorage.removeItem('refresh_token');
        
        // Show success message
        if (window.toast) {
            window.toast.success('Logged out successfully!');
        }
        
        // Redirect to home page
        setTimeout(() => {
            window.location.href = '/';
        }, 1000);
    }

    // Initialize auth UI when page loads
    document.addEventListener('DOMContentLoaded', function() {
        updateAuthUI();
        
        // Add auth header to all HTMX requests
        document.body.addEventListener('htmx:configRequest', function(evt) {
            const token = localStorage.getItem('access_token');
            if (token) {
                evt.detail.headers['Authorization'] = 'Bearer ' + token;
            }
        });
        
        // Handle auth errors in HTMX responses
        document.body.addEventListener('htmx:responseError', function(evt) {
            if (evt.detail.xhr.status === 401) {
                // Unauthorized - clear tokens and reload auth UI
                localStorage.removeItem('access_token');
                localStorage.removeItem('refresh_token');
                updateAuthUI();
                
                if (window.toast) {
                    window.toast.error('Session expired. Please login again.');
                }
            }
        });
    });

    // Global function to check if user is authenticated
    window.isAuthenticated = function() {
        return !!localStorage.getItem('access_token');
    }

    // Global function to get current user (async)
    window.getCurrentUser = async function() {
        const token = localStorage.getItem('access_token');
        if (!token) return null;
        
        try {
            const response = await fetch('/auth/check', {
                headers: {
                    'Authorization': 'Bearer ' + token
                }
            });
            
            if (response.ok) {
                return await response.json();
            }
            return null;
        } catch (error) {
            console.error('Failed to get current user:', error);
            return null;
        }
    }

    // Make functions available globally
    window.updateAuthUI = updateAuthUI;
    window.logout = logout;
    </script>

    <style>
    .user-nav {
        display: flex;
        align-items: center;
        gap: 1rem;
        flex-wrap: wrap;
    }

    .user-info {
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        gap: 0.25rem;
    }

    .user-name {
        font-weight: 600;
        color: var(--dark-color);
    }

    .user-badges {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
    }

    .user-actions {
        display: flex;
        gap: 0.5rem;
        align-items: center;
    }

    .auth-buttons {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        flex-wrap: wrap;
    }

    .btn-github {
        background: #24292e;
        color: white;
        border: 1px solid #24292e;
    }

    .btn-github:hover {
        background: #2ea44f;
        border-color: #2ea44f;
    }

    .badge {
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        font-size: 0.75rem;
        font-weight: 600;
    }

    .badge-success {
        background: var(--success-color);
        color: white;
    }

    .badge-warning {
        background: var(--warning-color);
        color: var(--dark-color);
    }

    .loading {
        display: inline-block;
        width: 1rem;
        height: 1rem;
        border: 2px solid #f3f3f3;
        border-top: 2px solid var(--primary-color);
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    /* Responsive design */
    @media (max-width: 768px) {
        .user-nav {
            flex-direction: column;
            align-items: flex-start;
            gap: 0.5rem;
        }
        
        .user-info {
            align-items: flex-start;
        }
        
        .auth-buttons {
            flex-direction: column;
            align-items: flex-start;
        }
        
        .nav-links {
            flex-wrap: wrap;
            gap: 0.5rem;
        }
    }
    </style>
</body>
</html>